<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
    <title>登录页面</title>
    <script type="text/javascript" src="/js/plugins/login.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/login.css" />
    <link rel="stylesheet" type="text/css" href="/css/plugins/all.min.css" />
    <div th:include="common/head :: head"></div>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
<div id="vue" class="login-container bg-white rounded-xl p-8 w-full max-w-md relative overflow-hidden">
    <!-- 水波纹装饰效果 -->
    <div class="absolute -top-20 -right-20 w-40 h-40 rounded-full bg-blue-50 opacity-30"></div>
    <div class="absolute -bottom-20 -left-20 w-40 h-40 rounded-full bg-blue-50 opacity-30"></div>

    <!-- Logo区域 -->
    <div class="flex flex-col items-center mb-8">
        <h1 class="text-2xl font-bold text-gray-800">鉴权登录测试</h1>
        <p class="text-gray-500 mt-1">Spring Security Test</p>
    </div>

    <el-form :model="form" ref="form" :rules="rules" status-icon class="demo-ruleForm">
        <div class="login_input">用户名</div>
        <el-form-item label="" prop="userName">
            <el-input placeholder="请输入用户名" v-model="form.userName" ></el-input>
        </el-form-item>
        <div class="login_input">密码</div>
        <el-form-item label="" prop="password">
            <el-input placeholder="请输入密码" type="password" v-model="form.password" autocomplete="off"></el-input>
        </el-form-item>
        <div style="text-align: right">
            <el-link href="https://element.eleme.io" target="_blank"  type="primary">注册用户</el-link>
        </div>
        <el-button style="width: 100%" type="primary" @click="submitForm">登录</el-button>
    </el-form>

    <!-- 底部信息 -->
    <div class="mt-8 pt-5 border-t border-gray-200 text-center">
        <p class="text-xs text-gray-500">系统版本: v1.0.1</p>
        <p class="text-xs text-gray-500 mt-2"><i class="fas fa-shield-alt mr-1"></i>请保护您的账号信息</p>
    </div>
</div>

<!-- 创建当前页Vue对象 -->
<script th:inline="javascript">
    let item = new Vue({
        el: '#vue',
        data: {
            form: {
                userName: '',
                password: '',
            },
            rules: {
                userName: [{required: true, message: '请输入用户名', trigger: 'blur'}],
                password: [{required: true, message: '请输入密码', trigger: 'blur'}],
            },
        },
        methods: {
            // 提交表单
            submitForm() {
                this.$refs['form'].validate((valid) => {
                    if (valid) {
                        axios.post('/api/auth/login', this.form)
                            .then(response => {
                                if(response.data.code === 200){
                                    this.$message.success("登录成功!");
                                    // 登录成功，设置 Cookie
                                    document.cookie = `token=${response.data.data}; max-age=${3 * 60 * 60}; path=/`;
                                    // 查询当前登录用户信息
                                    this.getLoginUser()
                                }else {
                                    this.$message.error(response.data.data);
                                }
                            })
                            .catch(error => {
                                this.$message.error("登录失败: " + error.message);
                            });
                    } else {
                        console.log('表单验证失败');
                        return false;
                    }
                });
            },
            // 获取当前登录用户信息
            async getLoginUser() {
                axios.get("/api/auth/getLoginUser", {
                    params: {}
                }).then(response => {
                    if (response.data.code === 200) {
                        localStorage.setItem("user", JSON.stringify(response.data.data));
                        // 登录成功后重定向到计划页
                        window.location.href = '/';
                    } else {
                        this.$message.error(response.data.data);
                    }
                }).catch(error => {
                    this.$message.error("获取登录用户信息异常: " + error.message);
                });
            },
        },
    })
</script>
</body>
</html>