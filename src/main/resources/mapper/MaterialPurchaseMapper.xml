<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cps.material.mapper.MaterialPurchaseMapper">

    <!-- 手动映射 ResultMap -->
    <resultMap id="MaterialPurchaseResultMap" type="com.cps.material.model.MaterialPurchase">
        <!-- 主表字段映射 -->
        <id property="id" column="id" />
        <result property="analysisId" column="analysis_id" />
        <result property="serialNumber" column="serial_number" />
        <result property="systemNumber" column="system_number" />
        <result property="materialCode" column="material_code" />
        <result property="productName" column="product_name" />
        <result property="englishName" column="english_name" />
        <result property="material" column="material" />
        <result property="specification" column="specification" />
        <result property="brand" column="brand" />
        <result property="unit" column="unit" />
        <result property="quantity" column="quantity" />
        <result property="itemNumber" column="item_number" />
        <result property="deliveryDate" column="delivery_date" />
        <result property="materialJson" column="material_json" />
        <result property="status" column="status" />
        <result property="createTime" column="create_time" />
        <result property="updateTime" column="update_time" />

        <!-- 关联表字段映射（非表字段，手动映射） -->
        <result property="code" column="code" />
        <result property="fileName" column="file_name" />
        <result property="description" column="description" />
    </resultMap>

    <!-- 使用 ResultMap 的查询 -->
    <select id="selectPageList" resultMap="MaterialPurchaseResultMap">
        SELECT
        t1.id, t1.analysis_id, t1.serial_number, t1.system_number, t1.material_code,
        t1.product_name, t1.english_name, t1.material, t1.specification, t1.brand,
        t1.unit, t1.quantity, t1.item_number, t1.delivery_date, t1.material_json,
        t1.status, t1.create_time, t1.update_time,
        t2.code, t2.file_name, t3.description
        FROM
        material_purchase t1
        LEFT JOIN material_analysis t2 ON t1.analysis_id = t2.id
        LEFT JOIN material_info t3 ON t1.material_code = t3.number
        <where>
            t1.is_deleted = 0
            AND t2.is_deleted = 0
            <!-- 使用 param.xxx 访问对象属性 -->
            <if test="param.status != null">
                AND t1.status = #{param.status}
            </if>
            <if test="param.code != null and param.code != ''">
                AND t2.code LIKE CONCAT('%', #{param.code}, '%')
            </if>
            <if test="param.brand != null and param.brand != ''">
                AND t1.brand LIKE CONCAT('%', #{param.brand}, '%')
            </if>
            <if test="param.productName != null and param.productName != ''">
                AND t1.product_name LIKE CONCAT('%', #{param.productName}, '%')
            </if>
            <if test="param.material != null and param.material != ''">
                AND t1.material LIKE CONCAT('%', #{param.material}, '%')
            </if>
            <if test="param.specification != null and param.specification != ''">
                AND t1.specification LIKE CONCAT('%', #{param.specification}, '%')
            </if>
            <if test="param.materialCode != null and param.materialCode != ''">
                AND t1.material_code LIKE CONCAT('%', #{param.materialCode}, '%')
            </if>
        </where>
        ORDER BY t2.code DESC, CAST(t1.serial_number AS INTEGER), t1.create_time DESC
    </select>

</mapper>